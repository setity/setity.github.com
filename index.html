<!DOCTYPE html>
<html>
<head>
<title>本地TXT阅读器</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg t='1719904173616' class='icon' viewBox='0 0 1024 1024' version='1.1' xmlns='http://www.w3.org/2000/svg' p-id='5549' width='200' height='200'><path d='M344.6528 128c56.32 0 112.0768 17.0752 167.3472 51.2l9.7536-5.8368C573.824 143.104 626.3552 128 679.3472 128H972.8v742.4H676.7616c-58.0096 0-112.9216 17.0752-164.7616 51.2-51.84-34.1248-106.752-51.2-164.7616-51.2H51.2V128h293.4528z m0 76.8H128v588.8h219.2384c43.5712 0 85.8112 7.6288 126.3872 22.7072L473.6 245.76l-1.9712-1.2288C428.1088 217.6512 386.1248 204.8 344.6528 204.8zM896 204.8h-216.6528c-36.1728 0-72.704 9.7536-109.568 29.6704l-8.5504 4.7616-10.8288 6.4768v570.5728a360.448 360.448 0 0 1 115.4048-22.528l10.9568-0.1536H896V204.8z m-76.8 332.8v76.8h-192v-76.8H819.2z m-422.4 0v76.8H204.8v-76.8h192zM819.2 358.4v76.8h-192v-76.8H819.2z m-422.4 0v76.8H204.8v-76.8h192z' p-id='5550' fill='%23ffffff'></path></svg>">
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f0f0f0;
  margin: 20px;
  padding: 0;
}

h1 {
  text-align: center;
  color: #333;
  display: block;
}

#fileInput {
  display: none;
}

.label-input {
  margin-top: 15px;
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.label-input label {
  margin-right: 10px;
  color: #666;
  font-weight: bold;
}

.label-input input[type="file"], .label-input input[type="text"], .label-input select {
  padding: 8px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.label-input button {
  padding: 8px 16px;
  font-size: 14px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

#searchInput {
  flex-grow: 1;
  width:10px;
  background-color: #f0f0f0; /* 输入框颜色 */
}

#searchResults {
  margin-top: 20px;
}

#content {
  margin-top: 20px;
  margin-bottom: 20px;
  white-space: pre-line;
  font-size: 16px;
}

.pageButton {
  padding: 8px 16px;
  font-size: 14px;
  background-color: #ddd;
  color: #333;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 5px;
}

.pageButton:hover {
  background-color: #ccc;
}

.currentPage {
  background-color: #4CAF50;
  color: white;
}

.hidden {
  display: none;
}

.highlight {
  background-color: yellow;
}

#settings {
  margin-top: 20px;
  display: flex;
  align-items: center;
  background-color: #f0f0f0;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

#settings label {
  margin-right: 10px;
  color: #666;
}

#settings select, #settings input[type="color"], #settings input[type="number"] {
  padding: 8px;
  font-size: 14px;
  border: 1px solid #ccc;
  background-color: #f0f0f0; /* 输入框颜色 */
  border-radius:4px;
  width: 75px;
}

#applySettingsButton {
  padding: 8px 16px;
  font-size: 14px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-left: 10px;
}

#applySettingsButton:hover {
  background-color: #45a049;
}

.searchResult {
  margin-bottom: 10px;
  padding: 10px;
  border: 1px solid #ddd;
  background-color: #f9f9f9;
  cursor: pointer;
}

.searchResult:hover {
  background-color: #f0f0f0;
}
</style>
</head>
<body>
<div id="scrollInfo"></div>
<h1 id="pageTitle">本地TXT阅读器</h1>
<div id="fileSelection" class="label-input">
  <label for="fileInput">选择文件：</label>
  <input type="file" id="fileInput">
  <button id="loadFileButton">加载文件</button>
</div>
<div id="content"></div>
<div id="pageButtons"></div>
<div id="settings">
  <label for="backgroundColorSelect">&emsp;背景颜色</label>
  <select id="backgroundColorSelect">
    <option value="">默认</option>
    <option value="#FFFFFF">白雪</option>
    <option value="#000000">漆黑</option>
    <option value="#FFFFED">明黄</option>
    <option value="#EEFAEE">淡绿</option>
    <option value="#CCE8CF">草绿</option>
    <option value="#FCEFFF">红粉</option>
    <option value="#EFEFEF">深灰</option>
    <option value="#F5F5DC">米色</option>
    <option value="#D2B48C">茶色</option>
    <option value="#C0C0C0">银色</option>
  </select>
  <label for="fontSizeInput">&emsp;字体大小</label>
  <input type="number" id="fontSizeInput" value="16">
  <label for="fontColorSelect">&emsp;字体颜色</label>
  <select id="fontColorSelect">
    <option value="">默认</option>
    <option value="#9370DB">暗紫</option>
    <option value="#2E8B57">藻绿</option>
    <option value="#2F4F4F">深灰</option>
    <option value="#778899">青灰</option>
    <option value="#800000">栗色</option>
    <option value="#6A5ACD">青蓝</option>
    <option value="#BC8F8F">玫褐</option>
    <option value="#F4A460">黄褐</option>
    <option value="#F5F5DC">米色</option>
    <option value="#F5F5F5">雾白</option>
  </select>
  <label for="fontWeightSelect">&emsp;粗细</label>
  <select id="fontWeightSelect">
    <option value="normal">正常</option>
    <option value="bold">粗体</option>
  </select>
  <button id="applySettingsButton">应用设置</button>
</div>
<div class="label-input">
  <label for="searchInput">搜索文件内容</label>
  <input type="text" id="searchInput" placeholder="输入关键词">&emsp;
  <button id="searchButton">搜索</button>
</div>
<div id="searchResults"></div>
<script>
let textContent = '';

document.getElementById('loadFileButton').addEventListener('click', function() {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      textContent = e.target.result;
      // 清空内容和分页按钮
      document.getElementById('content').innerHTML = '';
      document.getElementById('pageButtons').innerHTML = '';
      document.getElementById('searchResults').innerHTML = '';
      // 按照每页10000字进行分割
      let pagesHTML = '';
      let paragraphsArray = textContent.split('\n');
      let currentPageLength = 0;
      let currentPageContentHTML = '';
      let currentPageNumber = 1;
      for (let i = 0; i < paragraphsArray.length; i++) {
        currentPageContentHTML += '&emsp;&emsp;' + paragraphsArray[i] + '&emsp;&emsp;';
        currentPageLength += paragraphsArray[i].length;
        if (currentPageLength >= 10000) {
          pagesHTML += '<div class="page" id="page' + currentPageNumber + '">' + currentPageContentHTML + '</div>';
          currentPageLength = 0;
          currentPageContentHTML = '';
          currentPageNumber++;
        }
      }
      if (currentPageContentHTML !== '') {
        pagesHTML += '<div class="page" id="page' + currentPageNumber + '">' + currentPageContentHTML + '</div>';
      }
      document.getElementById('content').innerHTML = pagesHTML;
      // 隐藏文件选择区域和页面标题
      document.getElementById('fileSelection').style.display = 'none';
      document.getElementById('pageTitle').style.display = 'none';
      // 显示记录的页码或第一页
      const savedPage = localStorage.getItem('currentPage');
      if (savedPage) {
        showPage(parseInt(savedPage));
      } else {
        showPage(1); // 显示第一页
      }
    };
    reader.readAsText(file);
  }
});

function showPage(pageNumber) {
  // 隐藏所有页面
  const pages = document.getElementsByClassName('page');
  for (let i = 0; i < pages.length; i++) {
    pages[i].style.display = 'none';
  }
  // 显示指定页面
  const page = document.getElementById('page' + pageNumber);
  if (page) {
    page.style.display = 'block';
  }
  // 更新页数显示
  const pageButtons = document.getElementsByClassName('pageButton');
  for (let i = 0; i < pageButtons.length; i++) {
    pageButtons[i].classList.remove('currentPage');
  }
  // 更新本地存储的页码
  localStorage.setItem('currentPage', pageNumber);
  // 更新页码显示
  updatePageButtons(pageNumber);
  // 定位到页面最上方
  window.scrollTo(0, 0);
  // 显示提示信息
  const scrollInfo = document.getElementById('scrollInfo');
  scrollInfo.textContent = `第 ${pageNumber} 页，朗读请点击地址栏末尾的朗读按钮`;
  scrollInfo.style.color = 'red'; // 设置颜色为红色
  scrollInfo.style.fontWeight = 'bold'; // 加粗显示
  // 设置定时器，在4秒后隐藏提示信息
  setTimeout(function() {
    scrollInfo.textContent = '';
  }, 4000);
  // 隐藏搜索结果
  document.getElementById('searchResults').innerHTML = '';
}

function updatePageButtons(currentPage) {
  const pageButtonsDiv = document.getElementById('pageButtons');
  const totalPages = document.getElementsByClassName('page').length;
  const visiblePages = 5;
  pageButtonsDiv.innerHTML = '';

  // 添加上一页按钮
  if (totalPages > 1 && currentPage > 1) {
    const prevButton = document.createElement('span');
    prevButton.classList.add('pageButton');
    prevButton.innerText = '上一页';
    prevButton.addEventListener('click', function() {
      showPage(currentPage - 1);
    });
    pageButtonsDiv.appendChild(prevButton);
  }

  // 当前页及前后2个页码
  let startPage = currentPage - 2;
  let endPage = currentPage + 2;
  if (startPage < 1) {
    startPage = 1;
    endPage = Math.min(totalPages, visiblePages);
  }
  if (endPage > totalPages) {
    endPage = totalPages;
    startPage = Math.max(1, totalPages - visiblePages + 1);
  }
  if (startPage > 1) {
    const firstPageButton = document.createElement('span');
    firstPageButton.classList.add('pageButton');
    firstPageButton.innerText = '1';
    firstPageButton.addEventListener('click', function() {
      showPage(1);
    });
    pageButtonsDiv.appendChild(firstPageButton);
    if (startPage > 2) {
      const ellipsis = document.createElement('span');
      ellipsis.innerText = '...';
      pageButtonsDiv.appendChild(ellipsis);
    }
  }
  for (let i = startPage; i <= endPage; i++) {
    const pageButton = document.createElement('span');
    pageButton.classList.add('pageButton');
    pageButton.innerText = i;
    if (i === currentPage) {
      pageButton.classList.add('currentPage');
    }
    pageButton.addEventListener('click', function() {
      showPage(i);
    });
    pageButtonsDiv.appendChild(pageButton);
  }
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const ellipsis = document.createElement('span');
      ellipsis.innerText = '...';
      pageButtonsDiv.appendChild(ellipsis);
    }
    const lastPageButton = document.createElement('span');
    lastPageButton.classList.add('pageButton');
    lastPageButton.innerText = totalPages;
    lastPageButton.addEventListener('click', function() {
      showPage(totalPages);
    });
    pageButtonsDiv.appendChild(lastPageButton);
  }

  // 添加下一页按钮
  if (totalPages > 1 && currentPage < totalPages) {
    const nextButton = document.createElement('span');
    nextButton.classList.add('pageButton');
    nextButton.innerText = '下一页';
    nextButton.addEventListener('click', function() {
      showPage(currentPage + 1);
    });
    pageButtonsDiv.appendChild(nextButton);
  }
}

document.getElementById('searchButton').addEventListener('click', function() {
  const searchTerm = document.getElementById('searchInput').value.trim();
  if (searchTerm === '') {
    return;
  }
  const pages = document.getElementsByClassName('page');
  const searchResultsDiv = document.getElementById('searchResults');
  searchResultsDiv.innerHTML = '';
  let searchCount = 0;

  for (let i = 0; i < pages.length; i++) {
    const pageContent = pages[i].textContent;
    const searchTermIndex = pageContent.indexOf(searchTerm);
    if (searchTermIndex !== -1) {
      const contextBefore = pageContent.substring(Math.max(0, searchTermIndex - 50), searchTermIndex);
      const contextHighlighted = pageContent.substring(searchTermIndex, searchTermIndex + searchTerm.length);
      const contextAfter = pageContent.substring(searchTermIndex + searchTerm.length, searchTermIndex + searchTerm.length + 50);

      const resultDiv = document.createElement('div');
      resultDiv.innerHTML = `${contextBefore}<span class="highlight">${contextHighlighted}</span>${contextAfter}`;
      resultDiv.classList.add('searchResult');
      resultDiv.addEventListener('click', function() {
        showPage(i + 1);
        searchResultsDiv.innerHTML = '';
      });
      searchResultsDiv.appendChild(resultDiv);
      searchCount++;
      // 每次搜索后向下翻动一页
      window.scrollBy({
      top: 600,
      behavior: "smooth",
      });
    }
  }

  if (searchCount === 0) {
    const noResultDiv = document.createElement('div');
    noResultDiv.textContent = '未找到匹配结果。';
    noResultDiv.classList.add('searchResult');
    searchResultsDiv.appendChild(noResultDiv);
  }
});

document.getElementById('applySettingsButton').addEventListener('click', function() {
  const backgroundColor = document.getElementById('backgroundColorSelect').value;
  const fontSize = document.getElementById('fontSizeInput').value + 'px';
  const fontColor = document.getElementById('fontColorSelect').value;
  const fontWeight = document.getElementById('fontWeightSelect').value;

  document.body.style.backgroundColor = backgroundColor;
  document.body.style.fontSize = fontSize;

  const pages = document.getElementsByClassName('page');
  for (let i = 0; i < pages.length; i++) {
    pages[i].style.backgroundColor = backgroundColor;
    pages[i].style.fontSize = fontSize;
    pages[i].style.color = fontColor;
    pages[i].style.fontWeight = fontWeight;
  }
});
</script>
</body>
</html>
