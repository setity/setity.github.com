<!DOCTYPE html>
<html>
<head>
<title>阅读器</title>
<style>
.page {
  page-break-after: always;
  margin-bottom: 20px;
  display: none;
  font-size: 16px;
  color: black;
  background-color: white;
  font-weight: normal;
}
#pageButtons {
  margin-top: 20px;
}
.pageButton {
  margin-right: 10px;
  cursor: pointer;
}
.currentPage {
  font-weight: bold;
  color: red;
  font-size: larger;
}
.hidden {
  display: none;
}
.highlight {
  background-color: yellow;
}
#searchResults {
  margin-top: 20px;
}
#settings {
  margin-top: 20px;
  display: flex;
  align-items: center;
}
label {
  margin-right: 10px;
}
select, input[type="color"], input[type="number"] {
  margin-right: 10px;
}
</style>
</head>
<body>
<h1>阅读器</h1>
<input type="file" id="fileInput"><br><br>
<input type="text" id="searchInput" placeholder="搜索关键词">
<button id="searchButton">搜索</button>
<div id="searchResults"></div>
<div id="content"></div>
<div id="pageButtons"></div>
<div id="settings">
  <label>背景颜色:</label>
  <select id="backgroundColorSelect">
    <option value="white">白色</option>
    <option value="#f0f0f0">淡灰色</option>
    <option value="#e0e0e0">浅灰色</option>
    <option value="#dcdcdc">灰色</option>
  </select>
  <label>字体大小:</label>
  <input type="number" id="fontSizeInput" value="16"> px
  <label>字体颜色:</label>
  <select id="fontColorSelect">
    <option value="black">黑色</option>
    <option value="darkslategray">深灰色</option>
    <option value="dimgray">灰色</option>
    <option value="darkgray">浅灰色</option>
  </select>
  <label>字体粗细:</label>
  <select id="fontWeightSelect">
    <option value="normal">正常</option>
    <option value="bold">粗体</option>
  </select>
  <button id="applySettingsButton">应用设置</button>
</div>
<script>
let textContent = '';

document.getElementById('fileInput').addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      textContent = e.target.result;
      // 清空内容和分页按钮
      document.getElementById('content').innerHTML = '';
      document.getElementById('pageButtons').innerHTML = '';
      document.getElementById('searchResults').innerHTML = '';
      // 增加 CSS 以保留原始格式
      document.getElementById('content').style.whiteSpace = "pre-line";
      // 按照每页10000字进行分割
      let pagesHTML = '';
      let paragraphsArray = textContent.split('\n');
      let currentPageLength = 0;
      let currentPageContentHTML = '';
      let currentPageNumber = 1;
      for (let i = 0; i < paragraphsArray.length; i++) {
        currentPageContentHTML += paragraphsArray[i] + '\n';
        currentPageLength += paragraphsArray[i].length;
        if (currentPageLength >= 10000) {
          pagesHTML += '<div class="page" id="page' + currentPageNumber + '">' + currentPageContentHTML + '</div>';
          currentPageLength = 0;
          currentPageContentHTML = '';
          currentPageNumber++;
        }
      }
      if (currentPageContentHTML !== '') {
        pagesHTML += '<div class="page" id="page' + currentPageNumber + '">' + currentPageContentHTML + '</div>';
      }
      document.getElementById('content').innerHTML = pagesHTML;
      // 显示记录的页码或第一页
      const savedPage = localStorage.getItem('currentPage');
      if (savedPage) {
        showPage(parseInt(savedPage));
      } else {
        showPage(1); // 显示第一页
      }
    };
    reader.readAsText(file);
  }
});

function showPage(pageNumber) {
  // 隐藏所有页面
  const pages = document.getElementsByClassName('page');
  for (let i = 0; i < pages.length; i++) {
    pages[i].style.display = 'none';
  }
  // 显示指定页面
  const page = document.getElementById('page' + pageNumber);
  if (page) {
    page.style.display = 'block';
  }
  // 更新页数显示
  const pageButtons = document.getElementsByClassName('pageButton');
  for (let i = 0; i < pageButtons.length; i++) {
    pageButtons[i].classList.remove('currentPage');
  }
  // 更新本地存储的页码
  localStorage.setItem('currentPage', pageNumber);
  // 更新页码显示
  updatePageButtons(pageNumber);
}

function updatePageButtons(currentPage) {
  const pageButtonsDiv = document.getElementById('pageButtons');
  const totalPages = document.getElementsByClassName('page').length;
  const visiblePages = 5;
  pageButtonsDiv.innerHTML = '';

  // 添加上一页按钮
  if (totalPages > 1 && currentPage > 1) {
    const prevButton = document.createElement('span');
    prevButton.classList.add('pageButton');
    prevButton.innerText = '上一页';
    prevButton.addEventListener('click', function() {
      showPage(currentPage - 1);
    });
    pageButtonsDiv.appendChild(prevButton);
  }

  // 当前页及前后2个页码
  let startPage = currentPage - 2;
  let endPage = currentPage + 2;
  if (startPage < 1) {
    startPage = 1;
    endPage = Math.min(totalPages, visiblePages);
  }
  if (endPage > totalPages) {
    endPage = totalPages;
    startPage = Math.max(1, totalPages - visiblePages + 1);
  }
  
  if (startPage > 1) {
    const firstPageButton = document.createElement('span');
    firstPageButton.classList.add('pageButton');
    firstPageButton.innerText = '1';
    firstPageButton.addEventListener('click', function() {
      showPage(1);
    });
    pageButtonsDiv.appendChild(firstPageButton);
    if (startPage > 2) {
      const ellipsis = document.createElement('span');
      ellipsis.innerText = '...';
      pageButtonsDiv.appendChild(ellipsis);
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    const pageButton = document.createElement('span');
    pageButton.classList.add('pageButton');
    if (i === currentPage) {
      pageButton.classList.add('currentPage');
    }
    pageButton.innerText = i;
    pageButton.addEventListener('click', function() {
      showPage(i);
    });
    pageButtonsDiv.appendChild(pageButton);
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const ellipsis = document.createElement('span');
      ellipsis.innerText = '...';
      pageButtonsDiv.appendChild(ellipsis);
    }
    const lastPageButton = document.createElement('span');
    lastPageButton.classList.add('pageButton');
    lastPageButton.innerText = totalPages;
    lastPageButton.addEventListener('click', function() {
      showPage(totalPages);
    });
    pageButtonsDiv.appendChild(lastPageButton);
  }

  // 添加下一页按钮
  if (totalPages > 1 && currentPage < totalPages) {
    const nextButton = document.createElement('span');
    nextButton.classList.add('pageButton');
    nextButton.innerText = '下一页';
    nextButton.addEventListener('click', function() {
      showPage(currentPage + 1);
    });
    pageButtonsDiv.appendChild(nextButton);
  }
}

document.getElementById('searchButton').addEventListener('click', function() {
  const searchTerm = document.getElementById('searchInput').value.trim();
  if (searchTerm) {
    const searchResultsDiv = document.getElementById('searchResults');
    searchResultsDiv.innerHTML = '';
    const pages = document.getElementsByClassName('page');
    let searchResults = [];
    
    for (let i = 0; i < pages.length; i++) {
      const pageContent = pages[i].textContent || pages[i].innerText;
      const regex = new RegExp(searchTerm, 'gi');
      let match;
      while ((match = regex.exec(pageContent)) !== null) {
        searchResults.push({
          page: i + 1,
          context: pageContent.substring(Math.max(0, match.index - 30), Math.min(pageContent.length, match.index + 30))
        });
      }
    }

    searchResults.forEach(result => {
      const resultDiv = document.createElement('div');
      resultDiv.innerHTML = `页码: ${result.page} - ...${result.context.replace(new RegExp(searchTerm, 'gi'), match => `<span class="highlight">${match}</span>`)}...`;
      resultDiv.classList.add('searchResult');
      resultDiv.addEventListener('click', function() {
        showPage(result.page);
        searchResultsDiv.innerHTML = '';
      });
      searchResultsDiv.appendChild(resultDiv);
    });
  }
});

document.getElementById('applySettingsButton').addEventListener('click', function() {
  const backgroundColor = document.getElementById('backgroundColorSelect').value;
  const fontSize = document.getElementById('fontSizeInput').value + 'px';
  const fontColor = document.getElementById('fontColorSelect').value;
  const fontWeight = document.getElementById('fontWeightSelect').value;

  document.body.style.backgroundColor = backgroundColor;
  document.body.style.fontSize = fontSize;

  const pages = document.getElementsByClassName('page');
  for (let i = 0; i < pages.length; i++) {
    pages[i].style.backgroundColor = backgroundColor;
    pages[i].style.fontSize = fontSize;
    pages[i].style.color = fontColor;
    pages[i].style.fontWeight = fontWeight;
  }
});

// 初始页面加载时检查本地存储是否有页码记录
const savedPage = localStorage.getItem('currentPage');
if (savedPage) {
  showPage(parseInt(savedPage));
} else {
  showPage(1); // 显示第一页
}
</script>
</body>
</html>
